<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>xuweb后台</title>
    <link rel="stylesheet" href="/layui/css/layui.css">
    <script src="/jquery/jquery-3.4.1.min.js"></script>
    <style>
        .my-body {
            display: flex;
            flex-wrap: nowrap;
            flex-direction: column;
        }

        .head_img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
        }

        .layui-tab-item {
            width: 100%;
        }

        /* .layui-tab-item{
            height: 100vh;
        } */
    </style>
</head>

<body>
    <div class="layui-layout layui-layout-admin">
        <div class="layui-header">
            <div class="layui-logo layui-hide-xs layui-bg-black">达州行</div>
            <!-- 头部区域（可配合layui 已有的水平导航） -->
            <ul class="layui-nav layui-layout-left">
                <!-- 移动端显示 -->
                <li class="layui-nav-item layui-show-xs-inline-block layui-hide-sm" lay-header-event="menuLeft">
                    <i class="layui-icon layui-icon-spread-left"></i>
                </li>

                <!-- <li class="layui-nav-item layui-hide-xs site-demo-active" data-type="tabAdd"><a>nav 1</a></li>
                <li class="layui-nav-item layui-hide-xs"><a href="">nav 2</a></li>
                <li class="layui-nav-item layui-hide-xs"><a href="">nav 3</a></li>
                <li class="layui-nav-item">
                    <a href="javascript:;">nav groups</a>
                    <dl class="layui-nav-child">
                        <dd><a href="">menu 11</a></dd>
                        <dd><a href="">menu 22</a></dd>
                        <dd><a href="">menu 33</a></dd>
                    </dl>
                </li> -->
            </ul>
            <ul class="layui-nav layui-layout-right">
                <li class="layui-nav-item layui-hide layui-show-md-inline-block">
                    <!-- <a onclick="openIframe('/admin/information')"> -->
                    <a>
                        <img src="<%= data[0].head_pic %>" class="layui-nav-img">
                        <%= data[0].nickname %>
                    </a>
                    <dl class="layui-nav-child">
                        <!-- <dd><a data-type="tabAdd">个人信息</a></dd> -->
                        <dd><a id="passChange">修改密码</a></dd>
                        <dd><a href="/admin/login/loginOut">登出</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item" lay-header-event="menuRight" lay-unselect>
                    <a href="javascript:;">
                        <i class="layui-icon layui-icon-more-vertical"></i>
                    </a>
                </li>
            </ul>
        </div>

        <div class="layui-side layui-bg-black">
            <div class="layui-side-scroll">
                <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
                <ul class="layui-nav layui-nav-tree" lay-filter="test">
                    <li class="layui-nav-item site-demo-active" data-type="tabAdd" value="/admin/rotation"><a>轮播管理</a>
                    </li>
                    <li class="layui-nav-item site-demo-active" data-type="tabAdd" value="/admin/user"><a>用户管理</a></li>
                    <li class="layui-nav-item site-demo-active" data-type="tabAdd" value="/admin/spot"><a>景点管理</a></li>
                    <li class="layui-nav-item">
                        <a class="" href="javascript:;">账户管理</a>
                        <dl class="layui-nav-child">
                            <dd class="site-demo-active" data-type="tabAdd" value="/admin/admins"><a>账户查询</a></dd>
                            <dd class="site-demo-active" data-type="tabAdd" value="/admin/admins/addadmins"><a>新增账号</a>
                            </dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item site-demo-active" data-type="tabAdd" value="/admin/travels"><a>游记管理</a>
                    </li>
                    <li class="layui-nav-item site-demo-active" data-type="tabAdd" value="/admin/delicous"><a>美食管理</a>
                    </li>
                    <li class="layui-nav-item site-demo-active" data-type="tabAdd" value="/admin/hotel"><a>酒店管理</a></li>
                    <li class="layui-nav-item site-demo-active" data-type="tabAdd" value="/admin/notice"><a>公告</a></li>
                    <li class="layui-nav-item">
                        <a class="" href="javascript:;">码表管理</a>
                        <dl class="layui-nav-child">
                            <dd class="site-demo-active" data-type="tabAdd" value="/admin/code"><a>码表查询</a></dd>
                            <dd class="site-demo-active" data-type="tabAdd" value="/admin/code/addCodeView"><a>新增码表</a>
                            </dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item">
                        <a class="" href="javascript:;">表情包管理</a>
                        <dl class="layui-nav-child">
                            <dd class="site-demo-active" data-type="tabAdd" value="/admin/emo"><a>表情包查询</a></dd>
                            <dd class="site-demo-active" data-type="tabAdd" value="/admin/emo/addMoreEmo"><a>批量新增表情包</a>
                            </dd>
                        </dl>
                    </li>
                </ul>
            </div>
        </div>

        <div class="layui-body my-body">
            <div class="layui-tab" lay-filter="navs_tab" lay-allowclose="true"
                style="display: flex;flex-direction: column;flex: 1;">
                <ul class="layui-tab-title" style="padding: 0;" id="my-layui-tab">
                    <li class="layui-this" lay-id="11">首页</li>
                </ul>
                <div class="layui-tab-content" style="display: flex;flex: 1;width: 100%;padding: 0;">
                    <iframe src="/admin/home" frameborder="0" id="demoAdmin"
                        style="width: 100%; flex: 1; border-radius: 2px;" class="layui-tab-item layui-show"></iframe>
                    <!-- <div class="layui-tab-item">内容2</div> -->
                </div>
            </div>
            <!-- <div class="site-demo-button" style="margin-bottom: 0;">
                <button class="layui-btn site-demo-active" data-type="tabAdd">新增Tab项</button>
                <button class="layui-btn site-demo-active" data-type="tabDelete">删除：商品管理</button>
                <button class="layui-btn site-demo-active" data-type="tabChange">切换到：用户管理</button>
            </div> -->
            <!-- 内容主体区域 -->
            <!-- <iframe src="/admin/information" frameborder="0" id="demoAdmin"
                style="width: 100%; flex: 1; border-radius: 2px;"></iframe> -->
        </div>

        <div class="layui-footer">
            <!-- 底部固定区域 -->
            底部固定区域
        </div>
        <div id="changeInformation" style="display: none;margin-right: 50px;">
            <form class="layui-form" style="margin-top: 20px;">
                <div class="layui-form-item">
                    <label class="layui-form-label">原密码</label>
                    <div class="layui-input-block">
                        <input type="password" id="password" value="" name="password" placeholder="请输入原密码" required
                            lay-verify="required" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">新密码</label>
                    <div class="layui-input-block">
                        <input type="password" id="newpassword" value="" name="newpassword" placeholder="请输入新密码"
                            required lay-verify="required" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">确认新密码</label>
                    <div class="layui-input-block">
                        <input type="password" id="repassword" value="" name="repassword" placeholder="请确认新密码" required
                            lay-verify="required" class="layui-input">
                    </div>
                </div>
            </form>
        </div>
        <script src="/layui/layui.js"></script>
        <!-- 引用ip地址 -->
        <script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>
        <script>
            const detectDeviceType = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
                navigator.userAgent) ? '手机' : '电脑'; //检测登陆设备
            $.post("/admin/index/ip", {
                ip: returnCitySN["cip"],
                city: returnCitySN["cname"],
                equipment: detectDeviceType
            }, function (result) {
                if (result && result.code == 303) {
                    // setCookie('bokeuser', result.data, -1);
                }
            });
        </script>
        <script>
            //JS 
            layui.use(['upload', 'element', 'layer', 'util'], function () {
                var element = layui.element,
                    layer = layui.layer,
                    util = layui.util,
                    $ = layui.$;
                var $ = layui.jquery,
                    upload = layui.upload

                $('#passChange').click(function () {
                    layer.open({
                        type: 1,
                        content: $(
                            '#changeInformation') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
                            ,
                        btn: ['确认', '取消'],
                        yes: function (index, layero) {
                            layer.load()
                            //按钮【按钮一】的回调
                            if (!checkinput()) {
                                layer.closeAll('loading')
                                return
                            }
                            let data = getData()
                            $.post('/admin/information/resetpassword', data).then(res => {
                                layer.closeAll('loading')
                                layer.alert(res.msg, function (i) {
                                    layer.close(index)
                                    layer.close(i)
                                    if (res.code == '200') {
                                        const a = document.createElement(
                                            'a')
                                        a.setAttribute('href',
                                            '/admin/login/loginOut')
                                        a.click();
                                    }
                                })
                            })
                        },
                        btn2: function (index, layero) {
                            //按钮【按钮二】的回调
                            layer.close(index)
                            //return false 开启该代码可禁止点击该按钮关闭
                        },
                        cancel: function () {
                            //右上角关闭回调

                            //return false 开启该代码可禁止点击该按钮关闭
                        },
                        btnAlign: 'c',
                        anim: 1,
                        area: ['600px', '300px'],
                    });
                })
                // 获取表单数据
                function getData() {
                    let password = $('#password').val();
                    let newpassword = $('#newpassword').val();
                    let repassword = $('#repassword').val();
                    return {
                        password,
                        newpassword,
                        repassword
                    }
                }
                // 判断输入
                function checkinput() {
                    let {
                        password,
                        newpassword,
                        repassword
                    } = getData()
                    if (!password) {
                        layer.msg('请输入原密码')
                        return false
                    }

                    if (!newpassword) {
                        layer.msg('请输入新密码')
                        return false
                    }

                    if (!repassword) {
                        layer.msg('请重新输入密码')
                        return false
                    }

                    if (password == newpassword) {
                        layer.msg('新旧密码一致')
                        return false
                    }

                    if (repassword !== newpassword) {
                        layer.msg('确认密码有误')
                        return false
                    }

                    return true
                }

                //头部事件
                util.event('lay-header-event', {
                    //左侧菜单事件
                    menuLeft: function (othis) {
                        layer.msg('展开左侧菜单的操作', {
                            icon: 0
                        });
                    },
                    menuRight: function () {
                        layer.open({
                            type: 1,
                            content: '<div style="padding: 15px;">处理右侧面板的操作</div>',
                            area: ['260px', '100%'],
                            offset: 'rt' //右上角
                                ,
                            anim: 5,
                            shadeClose: true
                        });
                    }
                });

                //触发事件
                var active = {
                    tabAdd: function (value) {
                        console.log('1111')
                        let tab = value[0].getAttribute("value")
                        let name = value[0].innerText
                        let data = $('#my-layui-tab li')
                        // for (let item in data){
                        //     console.log(item,'item')
                        // }
                        let arr = []
                        data.each(function () {
                            arr.push($(this).text())
                        })
                        let res = arr.find(item => item == name)
                        if (res) {
                            active.tabChange(tab)
                            return
                        }
                        //新增一个Tab项
                        element.tabAdd('navs_tab', {
                            title: name, //用于演示
                            content: `<iframe src="${tab}" frameborder="0" id="demoAdmin" height="100%"
                                style="width: 100%; flex: 1; border-radius: 2px;" class="layui-tab-item layui-show"></iframe>`,
                            id: tab
                        })
                        active.tabChange(tab)
                    },
                    tabDelete: function (othis) {
                        //删除指定Tab项
                        element.tabDelete('navs_tab', '44'); //删除：“商品管理”


                        othis.addClass('layui-btn-disabled');
                    },
                    tabChange: function (value) {
                        //切换到指定Tab项
                        element.tabChange('navs_tab', value); //切换到：用户管理
                    }
                };

                $('.site-demo-active').on('click', function () {
                    var othis = $(this),
                        type = othis.data('type');
                    active[type] ? active[type].call(this, othis) : '';
                });

                //Hash地址的定位
                var layid = location.hash.replace(/^#test=/, '');
                element.tabChange('test', layid);

                element.on('tab(test)', function (elem) {
                    location.hash = 'test=' + $(this).attr('lay-id');
                });

                //常规使用 - 普通图片上传
                var uploadInst = upload.render({
                    elem: '#test1',
                    auto: false,
                    bindAction: '#btn',
                    url: '/admin/setInformation/setHead' //改成您自己的上传接口
                        ,
                    choose: function (obj) {
                            //将每次选择的文件追加到文件队列
                            var files = obj.pushFile();

                            //预读本地文件，如果是多文件，则会遍历。(不支持ie8/9)
                            obj.preview(function (index, file, result) {
                                console.log(index); //得到文件索引
                                console.log(file); //得到文件对象
                                console.log(result); //得到文件base64编码，比如图片

                                //obj.resetFile(index, file, '123.jpg'); //重命名文件名，layui 2.3.0 开始新增
                                $('#test1').attr('src', result);
                                //这里还可以做一些 append 文件列表 DOM 的操作

                                //obj.upload(index, file); //对上传失败的单个文件重新上传，一般在某个事件中使用
                                //delete files[index]; //删除列表中对应的文件，一般在某个事件中使用
                            });
                        }
                        // ,before: function(obj){
                        //   //预读本地文件示例，不支持ie8
                        //   obj.preview(function(index, file, result){
                        //     $('#test1').attr('src', result); //图片链接（base64）
                        //   });

                        //   element.progress('demo', '0%'); //进度条复位
                        //   layer.msg('上传中', {icon: 16, time: 0});
                        // }
                        ,
                    done: function (res) {
                        console.log(res, 'res')
                        //如果上传失败
                        if (res.code > 0) {
                            return layer.msg('上传失败');
                        }
                        //上传成功的一些操作
                        //……
                        $('#demoText').html(''); //置空上传失败的状态
                    },
                    error: function () {
                            //演示失败状态，并实现重传
                            var demoText = $('#demoText');
                            demoText.html(
                                '<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>'
                            );
                            demoText.find('.demo-reload').on('click', function () {
                                uploadInst.upload();
                            });
                        }
                        //进度条
                        ,
                    progress: function (n, elem, e) {
                        element.progress('demo', n + '%'); //可配合 layui 进度条元素使用
                        if (n == 100) {
                            layer.msg('上传完毕', {
                                icon: 1
                            });
                        }
                    }
                });

            });

            function openIframe(src) {
                $('#demoAdmin').attr('src', src)
            }

            // layui.use('upload', function () {
            //     var upload = layui.upload;

            //     //执行实例
            //     var uploadInst = upload.render({
            //         elem: '#test1' //绑定元素
            //             ,
            //         url: '/admin/setInformation/setHead' //上传接口
            //             ,
            //         done: function (res) {
            //             console.log(res, '111')
            //             //上传完毕回调
            //         },
            //         error: function () {
            //             //请求异常回调
            //         }
            //     });
            // });
        </script>
</body>

</html>